<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binokub Patience REV 4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --card-width: 90px;
            --card-height: 130px;
            --card-radius: 8px;
            --card-offset: 35px; /* DÃ©calage pour les cartes empilÃ©es */
        }
        body {
            font-family: sans-serif;
            background-color: #0c4b33;
            color: white;
            padding: 1rem;
        }
        .game-container {
            max-width: 1200px;
            margin: auto;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }
        .piles {
            display: flex;
            gap: 1rem;
        }
        .card-placeholder {
            width: var(--card-width);
            height: var(--card-height);
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: var(--card-radius);
            position: relative;
        }
        #columns-container {
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 1rem;
            margin-top: 2rem;
            align-items: start;
        }
        .column-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .column-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
        }
        .base-column {
            position: relative;
            width: var(--card-width);
            height: calc(var(--card-height) + 8 * var(--card-offset));
            border: 2px solid transparent; /* Bordure pour la zone de dÃ©pÃ´t */
            border-radius: var(--card-radius);
        }
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: white;
            color: black;
            border-radius: var(--card-radius);
            border: 1px solid #999;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: absolute;
            user-select: none;
            cursor: grab;
        }
        .card-content { position: relative; width: 100%; height: 100%; font-weight: bold; }
        .card-top-left { position: absolute; top: 5px; left: 8px; font-size: 1.2rem; }
        .card-top-right { position: absolute; top: 5px; right: 8px; font-size: 1.5rem; }
        .card-back {
             background-color: #557c9a;
             background-image: linear-gradient(45deg, #4c718e 25%, transparent 25%, transparent 75%, #4c718e 75%, #4c718e), linear-gradient(-45deg, #4c718e 25%, transparent 25%, transparent 75%, #4c718e 75%, #4c718e);
             background-size: 20px 20px;
             cursor: pointer;
        }
        .base-1 { color: #D32F2F; } .base-2 { color: #1976D2; } .base-3 { color: #388E3C; } .base-4 { color: #7B1FA2; } .base-5 { color: #F57C00; } .base-6 { color: #0097A7; } .base-7 { color: #C2185B; } .base-8 { color: #6D4C41; } .base-9 { color: #455A64; }
    </style>
</head>
<body class="py-4">

    <div class="container game-container">
        <div class="top-bar">
            <div class="piles">
                <div id="stock-pile" class="card-placeholder"></div>
                <div id="waste-pile" class="card-placeholder" data-pile-type="waste"></div>
            </div>
            <button id="replay-btn" class="btn btn-light">Nouvelle Partie</button>
        </div>
        
        <div id="columns-container"></div>
    </div>

    <script>
        // REV 4.0
        document.addEventListener('DOMContentLoaded', () => {
            const CARD_BACK_DESIGN = 2; 
            const cardOffset = 35;

            let stock = [], waste = [], foundations = Array(10).fill().map(() => []);

            function getBase(number) { let s = number.toString(); while (s.length > 1) { s = s.split('').reduce((acc, val) => acc + parseInt(val), 0).toString(); } return parseInt(s); }
            
            function createCardElement(cardData) {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.number = cardData.number;
                card.dataset.isBaseCard = cardData.isBaseCard;
                card.dataset.base = getBase(cardData.number);
                if (cardData.faceUp) {
                    card.classList.add(`base-${getBase(cardData.number)}`);
                    if (cardData.isBaseCard) {
                        card.innerHTML = `<div class="card-content"><div class="card-top-left">${cardData.number}</div><div class="card-top-right">ðŸ‘‘</div></div>`;
                    } else {
                        card.innerHTML = `<div class="card-content"><div class="card-top-left">${cardData.number}</div></div>`;
                    }
                } else {
                    card.classList.add('card-back', `design-${CARD_BACK_DESIGN}`);
                }
                return card;
            }

            function render() {
                const stockPileEl = document.getElementById('stock-pile');
                const wastePileEl = document.getElementById('waste-pile');
                const columnsContainer = document.getElementById('columns-container');
                
                stockPileEl.innerHTML = ''; wastePileEl.innerHTML = ''; columnsContainer.innerHTML = '';

                if (stock.length > 0) {
                    const topCardEl = createCardElement(stock[stock.length - 1], false);
                    topCardEl.addEventListener('click', drawCard);
                    stockPileEl.appendChild(topCardEl);
                } else if (waste.length > 0) {
                    const recycleEl = document.createElement('div');
                    recycleEl.className = 'card-placeholder';
                    recycleEl.style.border = '2px solid white';
                    recycleEl.style.cursor = 'pointer';
                    recycleEl.addEventListener('click', drawCard);
                    stockPileEl.appendChild(recycleEl);
                }
                
                if (waste.length > 0) {
                    const topCardEl = createCardElement(waste[waste.length - 1]);
                    wastePileEl.appendChild(topCardEl);
                }

                for (let i = 1; i <= 9; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'column-wrapper';
                    const header = document.createElement('div');
                    header.className = 'column-header';
                    header.textContent = `Base ${i}`;
                    wrapper.appendChild(header);
                    const column = document.createElement('div');
                    column.className = 'base-column';
                    column.id = `base-column-${i}`;
                    column.dataset.pileType = 'foundation';
                    column.dataset.base = i;
                    wrapper.appendChild(column);
                    
                    if (foundations[i].length === 0) {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'card-placeholder';
                        column.appendChild(placeholder);
                    } else {
                        foundations[i].forEach((cardData, cardIndex) => {
                            const cardEl = createCardElement(cardData);
                            cardEl.style.top = `${cardIndex * cardOffset}px`;
                            cardEl.style.zIndex = cardIndex;
                            column.appendChild(cardEl);
                        });
                    }
                    columnsContainer.appendChild(wrapper);
                }
                makeDraggable();
            }
            
            function drawCard() {
                if (stock.length > 0) {
                    const card = stock.pop();
                    card.faceUp = true;
                    waste.push(card);
                } else if (waste.length > 0) {
                    stock = waste.map(c => ({...c, faceUp: false})).reverse();
                    waste = [];
                }
                render();
            }

            function handleCardMove(evt) {
                const movedCardEl = evt.item;
                const toEl = evt.to;

                if (waste.length === 0) { render(); return; }
                const movedCardData = waste[waste.length - 1];
                const targetBase = parseInt(toEl.dataset.base);
                
                if (getBase(movedCardData.number) === targetBase) {
                    // Mouvement valide
                    const targetPile = foundations[targetBase];
                    targetPile.push(waste.pop()); // DÃ©place la carte
                    // Tri automatique de la pile de destination
                    targetPile.sort((a, b) => a.number - b.number);
                } else {
                    alert("Mauvaise base !");
                }
                render(); // Redessine tout pour montrer le placement automatique
            }

            function makeDraggable() {
                const wasteContainer = document.getElementById('waste-pile');
                if (wasteContainer) {
                    new Sortable(wasteContainer, {
                        group: { name: 'patience', pull: true, put: false },
                        animation: 150,
                    });
                }

                document.querySelectorAll('.base-column').forEach(column => {
                    new Sortable(column, {
                        group: { name: 'patience', pull: false, put: true },
                        onAdd: handleCardMove
                    });
                });
            }

            function startGame() {
                stock = []; waste = [];
                foundations = Array(10).fill().map(() => []);
                const baseCards = Array.from({length: 9}, (_, i) => ({ number: i + 1, faceUp: false, isBaseCard: true }));
                let numberCards = [];
                for (let i = 10; i <= 81; i++) {
                    numberCards.push({ number: i, faceUp: false, isBaseCard: false });
                }
                stock = [...baseCards, ...numberCards].sort(() => 0.5 - Math.random());
                render();
            }

            document.getElementById('replay-btn').addEventListener('click', startGame);
            startGame();
        });
    </script>
</body>
</html>